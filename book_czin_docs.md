# Документация модуля "Книга Перемен (И-Цзин)"

## Общее описание модуля

Модуль "Книга Перемен" (Book Czin) предоставляет API для получения случайных гексаграмм из древнекитайской "Книги Перемен" (И-Цзин). Модуль разработан для интеграции с Telegram-ботами через платформу puzzlebot.top, позволяя пользователям получать случайные гексаграммы с их описанием и изображением при нажатии на кнопку "Получить ответ".

## Архитектура и основные компоненты

### Структура модуля
- **Models**: Содержит Pydantic-модели для валидации данных
- **Service**: Основной сервис для работы с гексаграммами
- **API-эндпоинты**: Предоставляют доступ к функциональности модуля

### Структура данных
- **Изображения**: Хранятся в папке `modules/book_czin/image_hex/` в формате PNG (имена файлов: `1.png`, `2.png`, ..., `64.png`)
- **Тексты**: Хранятся в папке `modules/book_czin/hexagrams/` в формате JSON (имена файлов: `1.json`, `2.json`, ..., `64.json`)

## Принцип работы

1. **Инициализация сервиса**:
   - Проверка наличия директорий с изображениями и текстами
   - Сканирование доступных гексаграмм (проверка соответствия номеров изображений и JSON-файлов)
   - Создание списка доступных гексаграмм

2. **Получение случайной гексаграммы**:
   - Выбор случайного номера гексаграммы из списка доступных
   - Загрузка данных гексаграммы из соответствующего JSON-файла
   - Формирование URL для доступа к изображению гексаграммы
   - Возврат данных в виде структурированного ответа

3. **Доступ к изображениям**:
   - Проверка существования запрошенного изображения
   - Возврат файла изображения с соответствующим MIME-типом

## API-эндпоинты

### GET `/api/v1/book-czin/random`

Возвращает случайно выбранную гексаграмму с её описанием и URL изображения.

**Ответ**:
```json
{
  "success": true,
  "data": {
    "number": 1,
    "title": "Творчество",
    "description": "Сила, творческая энергия, действие; созидающая и уничтожающая власть Неба; динамичность, неутомимость, стойкость, настойчивость.",
    "image_url": "http://localhost:8000/api/v1/book-czin/image/1",
    "sections": {
      "Название": "Цянъ (Творчество): духовная сила, творческая энергия...",
      "Образный ряд": "Изначальное свершение; благоприятна стойкость...",
      "Внешний и внутренний миры: небо и небо": "Динамичность, настойчивость и неуклонность...",
      "Определение": "Творчество означает силу.",
      "Символ": "Небо движется постоянно...",
      "Линии гексаграммы": "",
      "Вначале девятка": "Нырнувший дракон...",
      "Девятка вторая": "Появившийся дракон находится на поле...",
      "Девятка третья": "Благородный человек до конца дня деятелен...",
      "Девятка четвертая": "Точно прыжок в бездну...",
      "Девятка пятая": "Летящий дракон находится в небе...",
      "Наверху девятка": "Возгордившийся дракон...",
      "Все девятки": "При действии девяток смотри, чтобы все драконы не главенствовали..."
    }
  },
  "error": null
}
```

### GET `/api/v1/book-czin/image/{hexagram_number}`

Возвращает изображение гексаграммы с указанным номером.

**Параметры**:
- `hexagram_number`: Номер гексаграммы (1-64)

**Ответ**:
- Файл изображения в формате PNG
- В случае отсутствия изображения - ошибка 404

## Модели данных

### HexagramData
```python
class HexagramData(BaseModel):
    """Модель данных гексаграммы"""
    number: int
    title: str
    description: str
    sections: Dict[str, str]
```

### RandomHexagramResponse
```python
class RandomHexagramResponse(BaseModel):
    """Модель ответа с рандомной гексаграммой"""
    number: int
    title: str
    description: str
    image_url: str
    sections: Dict[str, str]
```

### ApiResponse
```python
class ApiResponse(BaseModel):
    """Общая модель ответа API"""
    success: bool
    data: Optional[RandomHexagramResponse] = None
    error: Optional[str] = None
```

## Интеграция с Telegram-ботом

Для интеграции с Telegram-ботом на платформе puzzlebot.top необходимо:

1. Создать кнопку "Получить ответ" в интерфейсе бота
2. Настроить обработчик нажатия на кнопку для отправки запроса к эндпоинту `/api/v1/book-czin/random`
3. При получении ответа:
   - Загрузить изображение по полученному URL (`data.image_url`)
   - Отправить изображение пользователю
   - Отправить текст с описанием гексаграммы (можно использовать `data.title`, `data.description` и выбранные секции из `data.sections`)

## Обработка ошибок

1. **Ошибки инициализации**:
   - Отсутствие директорий с изображениями или текстами
   - Отсутствие доступных гексаграмм

2. **Ошибки при получении данных**:
   - Ошибки при загрузке JSON-файлов
   - Отсутствие запрошенного изображения

3. **Обработка исключений**:
   - Логирование ошибок
   - Возврат информативных сообщений об ошибках в ответе API

## Конфигурационные параметры

- `BASE_URL`: Базовый URL для формирования полных URL к изображениям (по умолчанию: "http://localhost:8000")

## Заключение

Модуль "Книга Перемен" предоставляет простой и надежный способ интеграции функциональности И-Цзин в Telegram-боты через платформу puzzlebot.top. Архитектура модуля обеспечивает легкое масштабирование и поддержку, а также позволяет легко добавлять новые гексаграммы или модифицировать существующие. 