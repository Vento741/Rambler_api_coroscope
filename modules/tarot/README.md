# Модуль Таро

Модуль Таро предоставляет функциональность для проведения гаданий на картах Таро с использованием OpenRouter API для генерации интерпретаций.

## Основные компоненты

- **models.py** - Определяет модели данных для карт Таро, раскладов и результатов гаданий
- **data.py** - Содержит базу данных карт Таро (Старшие и Младшие Арканы) и доступных раскладов
- **openrouter_service.py** - Реализует сервис для взаимодействия с OpenRouter API, включая логику выбора карт и формирования запросов
- **prompts.py** - Содержит специализированные промпты для различных раскладов и типов пользователей

## API эндпоинты

API эндпоинты для работы с модулем Таро определены в файле `api/v1/tarot.py` и включают:

1. `GET /api/v1/tarot/cards` - Получение списка всех карт Таро
2. `GET /api/v1/tarot/cards/{card_id}` - Получение информации о конкретной карте
3. `GET /api/v1/tarot/spreads` - Получение списка доступных раскладов
4. `GET /api/v1/tarot/spreads/{spread_id}` - Получение информации о конкретном раскладе
5. `POST /api/v1/tarot/reading` - Выполнение гадания на картах Таро (POST метод)
6. `GET /api/v1/tarot/reading` - Выполнение гадания на картах Таро (GET метод)
7. `GET /api/v1/tarot/card-image/{card_id}` - Получение изображения карты Таро
8. `GET /api/v1/tarot/collage` - Генерация коллажа из карт Таро для расклада

## Особенности реализации

### Карты Таро

База данных карт Таро включает:
- 22 карты Старших Арканов (от Шута до Мира)
- 56 карт Младших Арканов, разделенных на 4 масти:
  - Жезлы (14 карт)
  - Кубки (14 карт)
  - Мечи (14 карт)
  - Пентакли (14 карт)

Для каждой карты предоставляется информация о её значении в прямом и перевернутом положении, ключевые слова, описание и URL изображения.

### Расклады

Доступны следующие расклады:
1. **Расклад на один день** - Простой расклад из одной карты
2. **Расклад на три карты** - Классический расклад "прошлое-настоящее-будущее"
3. **Кельтский крест** - Детальный расклад из 10 карт
4. **Расклад на отношения** - Специализированный расклад для анализа отношений
5. **Расклад на желание** - Расклад для анализа шансов на исполнение желания

### Генерация интерпретаций

Интерпретации раскладов генерируются с использованием OpenRouter API. Промпты для генерации адаптированы под каждый тип расклада и категорию пользователя:
- **free** - базовая интерпретация с общими выводами
- **premium** - детальная интерпретация с глубоким анализом и персонализированными рекомендациями

### Особенности работы с изображениями

Модуль поддерживает работу с изображениями карт Таро:
- Получение отдельных изображений карт (с возможностью отображения в перевернутом виде)
- Генерация коллажей для различных типов раскладов с предустановленными шаблонами

## Использование

### Пример запроса для получения гадания

```python
import requests
import json

# Параметры запроса
params = {
    "spread_id": 2,  # Расклад на три карты
    "question": "Что меня ждет в ближайшем будущем?",
    "user_type": "premium"  # или "free"
}

# Выполнение запроса
response = requests.post(
    "https://api.example.com/api/v1/tarot/reading",
    json=params
)

# Обработка ответа
if response.status_code == 200:
    result = response.json()
    
    # Получение интерпретации
    interpretation = result["data"]["interpretation"]
    print(interpretation)
    
    # Получение данных о картах для отображения
    cards = result["data"]["cards"]
    
    # Создание коллажа
    card_urls = [card["card_image_url"] for card in cards]
    positions = [card["position_name"] for card in cards]
    
    collage_params = {
        "card_urls": card_urls,
        "positions": positions,
        "title": "Расклад на будущее",
        "spread_type": "three_cards"
    }
    
    collage_response = requests.get(
        "https://api.example.com/api/v1/tarot/collage",
        params=collage_params
    )
    
    # Сохранение коллажа
    if collage_response.status_code == 200:
        with open("tarot_reading.jpg", "wb") as f:
            f.write(collage_response.content)
```

## Документация

Полная документация по использованию модуля Таро доступна в следующих файлах:
- [API-инструкция](../../docs/tarot_api_guide.md) - подробное описание всех эндпоинтов и примеры использования
- [Команды бота](../../docs/tarot_bot_commands.md) - рекомендуемые команды для интеграции с Telegram-ботом

## Ограничения

- Free-пользователи ограничены 1 гаданием в день
- Premium-пользователи имеют ограничение на N гаданий в час

Логика ограничений должна быть реализована на стороне клиента (например, в Telegram-боте).

## Зависимости

Для работы с изображениями требуются следующие библиотеки:
- Pillow (PIL) - для обработки изображений
- aiohttp - для асинхронной загрузки изображений
- requests - для загрузки изображений в синхронном режиме 