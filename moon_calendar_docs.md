# Документация модуля "Лунный календарь"

## Общее описание проекта

Модуль "Лунный календарь" является частью API-сервиса, разработанного на FastAPI, который предоставляет информацию о лунных днях, фазах луны и рекомендациях на основе лунного календаря. Данные получаются путем парсинга внешнего источника (Rambler), обрабатываются и дополняются с помощью ИИ-моделей через OpenRouter API.

## Архитектура и основные компоненты

### Структура модуля
- **Parser**: Отвечает за парсинг данных с внешнего источника
- **Models**: Содержит Pydantic-модели для валидации данных
- **Service**: Основной сервис для работы с календарем
- **OpenRouterService**: Сервис для обогащения данных с помощью ИИ
- **Tasks**: Фоновые задачи для обновления кэша и генерации ответов

### Принцип работы

1. **Получение данных**:
   - Парсинг HTML-страницы с лунным календарем (horoscopes.rambler.ru)
   - Извлечение информации о лунных днях, фазе луны и рекомендациях
   - Структурирование данных в соответствии с моделями

2. **Кэширование**:
   - Сохранение спарсенных данных в кэш для уменьшения нагрузки на источник
   - Использование TTL (время жизни) для кэша
   - Проверка наличия данных в кэше перед парсингом

3. **Обогащение данных с помощью ИИ**:
   - Формирование промптов для ИИ-моделей на основе спарсенных данных
   - Отправка запросов к OpenRouter API для генерации ответов
   - Кэширование полученных ответов от ИИ

4. **API-эндпоинты**:
   - `/api/v1/moon-calendar/current` - данные на текущий день
   - `/api/v1/moon-calendar/{date}` - данные на конкретную дату

## Детальное описание компонентов

### MoonCalendarParser

Отвечает за асинхронное получение и парсинг данных с сайта Rambler.

**Основные методы**:
- `_fetch_page(calendar_date)`: Асинхронное получение HTML-страницы
- `_parse_moon_phase(soup)`: Извлечение информации о фазе луны
- `_parse_moon_days(soup, year)`: Извлечение информации о лунных днях
- `_parse_recommendations(soup)`: Извлечение рекомендаций
- `parse_calendar_day(calendar_date)`: Основной метод, объединяющий парсинг всех данных

**Обработка исключений**:
- Логирование ошибок при парсинге
- Возврат пустых структур данных при отсутствии информации
- Генерация HTTP-исключений при проблемах с доступом к источнику

### MoonCalendarService

Основной сервис для работы с календарем, использующий парсер и кэш.

**Основные методы**:
- `get_calendar_for_date(calendar_date)`: Получение данных календаря на дату

**Логика работы**:
1. Проверка наличия данных в кэше
2. Если данные есть - возврат из кэша
3. Если данных нет - парсинг, сохранение в кэш и возврат

### MoonCalendarOpenRouterService

Сервис для обогащения данных с помощью ИИ через OpenRouter API.

**Основные методы**:
- `get_moon_calendar_response(calendar_date, user_type)`: Получение ответа для пользователя
- `background_generate_and_cache_ai_responses(calendar_date)`: Фоновая генерация и кэширование ответов

**Логика работы**:
1. Получение спарсенных данных
2. Формирование промптов для ИИ в зависимости от типа пользователя (free/premium)
3. Отправка запросов к OpenRouter API с использованием разных моделей
4. Обработка и очистка ответов от ИИ
5. Кэширование полученных ответов

**Обработка ошибок**:
- Использование нескольких моделей с приоритетом при недоступности основной
- Логирование ошибок при генерации ответов
- Возврат информативных сообщений об ошибках

### MoonCalendarTasks

Класс для выполнения фоновых задач по обновлению кэша и генерации ответов.

**Основные методы**:
- `update_calendar_cache_and_generate_ai_responses()`: Обновление кэша для текущего и следующего дня
- `run_periodic_update(interval_minutes)`: Запуск периодического обновления

**Логика работы**:
1. Запуск в фоновом режиме с заданным интервалом
2. Парсинг данных для текущего и следующего дня
3. Сохранение спарсенных данных в кэш
4. Генерация и кэширование ответов от ИИ

**Механизмы защиты**:
- Флаг `_is_updating` для предотвращения одновременного запуска
- Обработка исключений для продолжения работы при ошибках
- Логирование всех этапов выполнения

## Основные переменные и параметры

### Конфигурационные параметры
- `CACHE_TTL_MINUTES`: Время жизни кэша в минутах
- `PARSER_TIMEOUT`: Таймаут для HTTP-запросов при парсинге
- `BACKGROUND_UPDATE_INTERVAL`: Интервал обновления кэша в минутах

### Типы пользователей
- `free`: Бесплатные пользователи (ограниченная информация)
- `premium`: Премиум пользователи (полная информация)

### Модели ИИ
Различные модели с приоритетом для разных типов пользователей:
- `google/gemini-2.0-flash-001`
- `google/gemini-2.0-flash-exp:free`
- `deepseek-r1-0528-qwen3-8b:free`
- `qwen/qwen2.5-vl-72b-instruct:free`

## Процесс обработки запросов

1. **Запрос от пользователя**:
   - Получение запроса на API-эндпоинт
   - Определение даты (текущая или указанная)
   - Определение типа пользователя (free по умолчанию)

2. **Обработка запроса**:
   - Проверка наличия кэшированного ответа от ИИ
   - Если ответ есть - немедленный возврат
   - Если ответа нет, но есть спарсенные данные - сообщение о том, что ответ еще не готов
   - Если данных нет - сообщение о том, что данные еще не обработаны

3. **Фоновая обработка**:
   - Периодический запуск задачи обновления кэша
   - Парсинг данных для текущего и следующего дня
   - Генерация ответов от ИИ для всех типов пользователей
   - Кэширование результатов

## Обработка исключений

1. **Ошибки парсинга**:
   - Логирование деталей ошибки
   - Возврат пустых структур или значений по умолчанию
   - Генерация HTTP-исключений с информативными сообщениями

2. **Ошибки ИИ-моделей**:
   - Попытка использования альтернативных моделей
   - Логирование ошибок
   - Информирование пользователя о статусе генерации

3. **Ошибки в фоновых задачах**:
   - Обработка исключений для продолжения работы
   - Логирование для дальнейшего анализа
   - Сброс флагов блокировки для следующих запусков

## Масштабирование и дальнейшее развитие

Текущая архитектура позволяет легко расширять функциональность:

1. **Новые источники данных**:
   - Создание новых парсеров для других источников
   - Интеграция через общий интерфейс

2. **Дополнительные типы пользователей**:
   - Добавление новых типов с различными уровнями доступа
   - Настройка соответствующих промптов и моделей

3. **Новые эндпоинты**:
   - Например, эндпоинт для получения рандомного ответа из набора изображений и текстов
   - Интеграция с Telegram-ботами через внешние платформы (например, puzzlebot.top)

## Заключение

Модуль "Лунный календарь" представляет собой хорошо структурированную систему для получения, обработки и предоставления данных о лунном календаре с использованием современных технологий асинхронного программирования, кэширования и ИИ-моделей. Архитектура обеспечивает надежность, производительность и масштабируемость решения. 